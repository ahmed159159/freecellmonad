<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>FreeCell -  ويب</title>
  <style>
    body { background:#064420; color:white; font-family:Arial; margin:0; }
    h1 { text-align:center; margin:10px; }
    #controls { text-align:center; margin:10px; }
    button {
      margin:5px; padding:8px 15px; border:none; border-radius:5px;
      background:#1b4332; color:white; cursor:pointer;
    }
    button:hover{ background:#2d6a4f; }
    #game { display:flex; flex-direction:column; align-items:center; }
    #top-row,#bottom-row { display:flex; justify-content:center; margin:10px; }
    .pile {
      width:80px; height:120px;
      border:1px dashed rgba(255,255,255,0.4);
      border-radius:8px; margin:5px; position:relative;
    }
    .card {
      width:80px; height:120px; border-radius:8px;
      position:absolute; cursor:grab;
    }
  </style>
</head>
<body>
  <h1> FreeCell</h1>
  <div id="controls">
    <button onclick="restartGame()">إعادة تشغيل</button>
    <button onclick="undoMove()">تراجع (Undo)</button>
    <button onclick="showHint()">تلميح (Hint)</button>
  </div>
  <div id="game">
    <div id="top-row">
      <div id="freecells" style="display:flex;"></div>
      <div id="foundations" style="display:flex; margin-left:50px;"></div>
    </div>
    <div id="bottom-row">
      <div id="tableau" style="display:flex;"></div>
    </div>
  </div>

<script>
const ranks=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
const suits=["S","H","D","C"];
let gameState={tableau:[],freecells:[],foundations:[],history:[]};

function cardId(c){return c.rank+c.suit;}
function cardColor(s){return (s==="H"||s==="D")?"red":"black";}
function createCardImg(card,idx=0,draggable=true){
  const img=document.createElement('img');
  img.className='card';
  img.src=`Cards/${card.rank}${card.suit}.jpg`;
  img.dataset.id=cardId(card);
  img.style.top=(idx*25)+"px";
  img.draggable=draggable;
  img.ondragstart=dragStart;
  return img;
}

function initDeck(){
  let d=[]; for (let r of ranks){ for (let s of suits){ d.push({rank:r,suit:s}); } }
  for (let i=d.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
  return d;
}

function restartGame(){
  const deck=initDeck();
  gameState.tableau=[[],[],[],[],[],[],[],[]];
  for (let i=0;i<deck.length;i++){ gameState.tableau[i%8].push(deck[i]); }
  gameState.freecells=[null,null,null,null];
  gameState.foundations=[[],[],[],[]];
  gameState.history=[];
  render();
}

function saveState(){ gameState.history.push(JSON.parse(JSON.stringify(gameState))); }
function undoMove(){ if (gameState.history.length>0){ gameState=gameState.history.pop(); render(); } }

function canPlaceOn(card,target){
  if (!target) return true;
  const ri=ranks.indexOf(card.rank), rt=ranks.indexOf(target.rank);
  return (ri===rt-1 && cardColor(card.suit)!==cardColor(target.suit));
}
function canPlaceOnFoundation(card,pile){
  if (pile.length===0) return card.rank==="A";
  const top=pile[pile.length-1];
  const ri=ranks.indexOf(card.rank), rt=ranks.indexOf(top.rank);
  return (ri===rt+1 && card.suit===top.suit);
}

// ===== Stack move support =====
function countEmptyFreecells(){ return gameState.freecells.filter(f=>!f).length; }
function countEmptyTableaus(){ return gameState.tableau.filter(p=>p.length===0).length; }
function maxMovableCards(){ return (countEmptyFreecells()+1)*Math.pow(2,countEmptyTableaus()); }
function validSequence(cards){
  for (let i=0;i<cards.length-1;i++){
    if (!canPlaceOn(cards[i],cards[i+1])) return false;
  }
  return true;
}

// Drag & Drop
let draggedCards=[],sourceIdx=null,sourceType=null;
function dragStart(e){
  const id=e.target.dataset.id;
  // from tableau: allow stack
  for (let i=0;i<8;i++){
    const pile=gameState.tableau[i];
    const idx=pile.findIndex(c=>cardId(c)===id);
    if (idx!==-1){
      const moving=pile.slice(idx);
      if (moving.length<=maxMovableCards() && validSequence(moving)){
        draggedCards=moving; sourceIdx=i; sourceType="tableau"; return;
      } else { draggedCards=[]; return; }
    }
  }
  // from freecell
  for (let i=0;i<4;i++){
    const c=gameState.freecells[i];
    if (c && cardId(c)===id){ draggedCards=[c]; sourceIdx=i; sourceType="freecell"; return; }
  }
}

function dropOnTableau(i){
  if (draggedCards.length===0) return;
  const pile=gameState.tableau[i];
  const target=pile[pile.length-1];

  // ✅ تعديل هنا
  if ((pile.length===0 && validSequence(draggedCards)) ||
      (pile.length>0 && canPlaceOn(draggedCards[0],target) && validSequence(draggedCards))) {
    saveState();
    if (sourceType==="tableau"){ gameState.tableau[sourceIdx].splice(-draggedCards.length); }
    else if (sourceType==="freecell"){ gameState.freecells[sourceIdx]=null; }
    gameState.tableau[i]=gameState.tableau[i].concat(draggedCards);
    draggedCards=[]; render();
  }
}

function dropOnFreecell(i){
  if (draggedCards.length!==1) return;
  if (!gameState.freecells[i]){
    saveState();
    if (sourceType==="tableau"){ gameState.tableau[sourceIdx].pop(); }
    else if (sourceType==="freecell") return;
    gameState.freecells[i]=draggedCards[0];
    draggedCards=[]; render();
  }
}

function dropOnFoundation(i){
  if (draggedCards.length!==1) return;
  const pile=gameState.foundations[i];
  if (canPlaceOnFoundation(draggedCards[0],pile)){
    saveState();
    if (sourceType==="tableau"){ gameState.tableau[sourceIdx].pop(); }
    else if (sourceTy
